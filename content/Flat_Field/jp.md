---
title: Flat Field jp
contributors:
  - Yz2house
---

<div class="pagetitle">

フラットフィールド

</div>

[thumb](image:Flatfield_landscape.jpg.md)
　\[<https://en.wikipedia.org/wiki/Flat-field_correction>　フラットフィールド補正\]（英語）はカメラとレンズの組み合わせによって生じる非均一な性質を補正するのに使われます。非均一な性質の例としてよく挙げられるのは、周辺光量‐画像の縁辺、特に四隅
が暗くなる現象です。もう1つは、特にデジタル中判カメラを使う人に知られているのが、レンズキャスト効果で、色と輝度に非均一性が現われることです。これら2つの性質は、レンズの誤調整やティルトシフトレンズの使用で更に複雑になります。また、カメラの光漏れ、撮像センサーの熱雑音、信号変換の欠陥や不規則性でも、この現象が起こります。この補正機能は、他のRaw現像ソフトでは、“LCC補正”などと呼ばれていますが、レンズに起因するものだけでなく、あらゆる原因で起こる非均一性を補正するという意味において、フラットフィールド補正と呼ぶ方が適当であると思います。

　これらの補正を編集中に手動で行うことは非常に困難です。特に様々な状況の下で撮影
された何枚もの画像を手直しするのは大変ですし、それによって精度の高い補正を行うことは滅多に出来ません。

　RawTherapeeの“フラットフィールド”補正には、自動的に行うものと、貴方の独自のモードで行う
2つがあります。但し、フラットフィールド補正が施せるのは、入力初期のリニアなrawデータだけでガンマ補正は行いません。よって、RawTherapeeではフラットフィールド補正が行えるのはraw
ファイルだけということになります。

　動作環境を考慮しているため、サムネイル画像はフラットフィールド補正を反映させていません。編集タブの[プレビュー画像だけです](The_Image_Editor_Tab/jp#プレビューパネル.md)。

　正確なフラットフィールド補正のためには、貴方が行う補正の種類－レンズ／カメラによる非均一性の補正、或いは撮像素子のゴミ跡除去―に必要な条件を満たすフラットフィールドを使用することが大切です。

　フラットフィールド補正を説明するために、フラットフィールド用画像そのもの使ってみましょう。“補正前”の画像（上）はグリーンの色被りだけでなく、明らかに非均一的な光量の減少も見られます。フラットフィールド補正は、この色被りと輝度の非均一性を取り除き、画像の状態を完全に均一にします。“補正後”の画像（下）のヒストグラムを見ると、画像の明暗に何の変化もないことが分ります－正しくこれが期待する均一（フラット）画像の姿です。フラットフィールド補正を行うと、これと同じ水準の補正が“実際”の画像にも反映されます。[thumb](image:Flatfield_remove_itself.jpg.md)

　“フラットフィールド”機能にあるパラメータの全ては処理プロファイルに保存されますので、それらの設定は他の画像に関しても、コピー＆ペーストで適用することが出来ます。これはフラットフィールドの“自動選択”でも同じことです。

## カメラ／レンズ収差を補正するためのフラットフィールド画像の作り方と使い方

　同じカメラボディとレンズの組み合わせに対し、補正に適用する画像は絞り毎に一枚で十分です。同じカメラとレンズなら、ダークフレームの様に、質を高めるために同じセッティングで画像を数枚撮り、それらを統合する、というような必要はありません。複数枚の画像を統合するとSN比が増えますし、フラットフィールドは低ISO画像で、ぼかしを入れて使うため複数枚の画像を統合する必要がありません。フラットフィールド用の画像は、出来るならISO感度100で撮影して下さい。ホワイトバランスには拘りません。カメラ／レンズ収差を補正するためにフラットフィールドを使う場合は、撮影する際のレンズの焦点距離にも拘りません（撮像素子のゴミ跡を除去する場合は話が別です）。撮影時の焦点距離はぼけたままで結構です。フラットフィールドに必要なのは、均一に照らされた、均一の色と明暗を持つ、焦点がぼけた画像なのです。

　フラットフィールドに適した画像を撮影するための最善策は、乳白色をした半透明のPoly製の（\[<https://ja.wikipedia.org/wiki/%E3%82%A2%E3%82%AF%E3%83%AA%E3%83%AB%E6%A8%B9%E8%84%82>　PMMA\]、Acrylite
、Lucite、Perspex、プレキシガラスなどの名前で販売されています）フィルターを通して撮影することです。フィルターは平坦で、色がなく、滑らかで、表面に記号や文字が彫られていないものです。樹脂板はホームセンターや画材店で見つかると思いますが、見つからなければ塗料缶の中にも同じ樹脂を使っているものがあるので、それが利用できます。この樹脂板をカメラレンズの径の大きさ程度に切ります。レンズの画角が、Samyang8mmフィッシュアイの様に極端に広い場合は、レンズの胴回りより数倍大きくする必要があります。最低でも20cmX20cm。樹脂板の厚みは、最低でも1㎜、できれば3㎜以上ほしいところです。厚みがあることによって、樹脂板を通った光線に十分なぼかしと拡散が得られるからです。樹脂板の表面が光沢を帯びている場合は、きめの細かい紙やすりで擦り、マット状にして下さい。これで貴方のフラットフィールドフィルターが完成です。

　レンズの前にフラットフィールドフィルターをかざし（密着させます）、露光は自動露出を選び、均一　な光の対象（例えば、雲のない青空）に向けて撮影します。理由はレンズに均一な光を入れるためです。こうすることで、普通に撮影したraw画像と比べ、カメラ／レンズ収差による全ての非均一性を特定し、補正するという訳です。フィルターを使って、異なる絞りで（f/1.4、f/2、f/2.8、f/4、f/5.6、f/8、f/11など）で一枚ずつ撮っておきます。白飛びを起こさないよう、ヒストグラムが中心に集まるよう、自動露出で撮影することをお忘れなく。

　貴方の使っているレンズが、単焦点レンズではなくズームレンズの場合は、フラットフィールドの撮　影が大まかなズーム倍率ごとに必要かどうか確認して下さい。例えば、貴方のズームレンズが18㎜～55㎜であるとすれば、18㎜、36㎜、55㎜で撮ったフラットフィールドが必要かもしれません。自分のカメラでテストして下さい。場合によっては、36㎜で撮った画像と55㎜で撮った画像は殆ど同じかもしれませんので、その場合は55㎜のフラットフィールドを用意せずとも足りるでしょう。

　貴方のレンズが電子制御であれば、RawTherapeeが自動的に正しいフラットフィールドを探しますので、そのファイル名は気にしないで構いません。しかし、昔のマニュアルレンズの場合は、絞りや焦点距離が記録されないので、貴方自身でファイル名を以下の様に、付けなければなりません：

` ff_`*<レンズ名>*`_`*<年月日>*`_`*<焦点距離>*`_`*<絞り>*`.`*<raw>*

例えば：

` ff_ pentax18-55mm_20141009_ 36mm_f11.dng`

このように名付ければ、手動で探す場合、簡単です。

　絞り値が実際の画像とマッチングするフラットフィールドを選んで適用し、“ぼかしの半径”は32以上を選びます。

　もし、PMMA製の樹脂板が見つけられず、且つ、フラットフィールドが直ぐにも必要な場合は、応急処置として、黒い壁、或いは大きなマット紙を、完全に焦点を外した状態で撮影して下さい。ここで難しいのは均一の光をどうするかです‐\[<https://ja.wikipedia.org/wiki/%E9%80%862%E4%B9%97%E3%81%AE%E6%B3%95%E5%89%87>　逆二乗の法則\]が邪魔になるのです。適切なフラットフィールドの撮影には、遠く離れた光源と、それによる光の拡散が必要ですが、部屋の明かりや、ストロボ光の拡散では十分ではありません。また、単なる紙ではPMM製樹脂板の代わりになりません。紙は樹脂板に比べ、はるかに不規則な部分が多く、厚みや密度による変化が明暗となり、そのまま貴方の実際の画像データから減じられてしまいます。ですから、どうしても紙を使う場合は、大きなブランクシートを用意し、それをなるべく均一な光が得られるような壁や窓ガラスに貼り付け、ズームで寄せ、焦点を外して撮影します。

## 撮像素子のゴミ跡を除去するためのフラットフィールドの作り方と使い方

　先のインストラクションに従いますが、部分的な変更と追加に注意して下さい。

　フラットフィールドをゴミ跡の除去に使う場合は、そのフラットフィールドの撮影が、適用したい実際の撮影のはるか以前とか、実際の撮影から長い間を置かないようにします。何故なら時間の経過と共に貴方のカメラの撮像センサーに、新しいゴミが付着したり、昔のゴミ跡が移動したり、無くなっている可能性があるからです。こういった場合には、完全なゴミ跡除去は叶いません。

　フラットフィールドをカメラ／レンズ収差の補正に使うことと、ゴミ跡の除去に使うこととの大きな違いは、後者はRawTherapeeの処理工程の中でフラットフィールド画像をぼかさないことで、そのために幾つか注意が必要です。ゴミ跡除去のためのフラットフィールドフィルター撮影は、より簡単で、速く、正確になりますが、絞りだけでなくレンズの焦点距離も考慮しなければなりません。ゴミ跡除去のために撮影したフラットフィールドの焦点距離が0.5mの場合、それを無限大で撮影した画像に適用した場合は殆ど失敗に終わると思います。何故なら焦点距離の違いで画像が若干変化するからで、それは単焦点レンズの場合でも同じです。しかし幸いなことに、拡大率による変位は非常に小さいものなので、短い焦点距離（例　0.5m）で撮影したもの、2ｍのもの、無限大のものを用意すれば十分だと思います。

　ズームレンズ使用の場合でも上記の注意事項は同じで、ファイルのネーミングに関しても、名前に　焦点距離を入れる方が望ましいと思います：

` ff_`*<レンズ名>*`_`*<年月日>*`_`*<焦点距離>*`_`*<絞り>*`_`*<焦点>*`.`*<raw>*

例えば：

` ff_ pentax18-55mm_20141009_36mm_f11_2m.dng`

　自宅で全ての場合に備えたフラットフィールド撮影を行う代わりに、レンズの径に近い小さなPMMA製のフラットフィールドフィルターを持っている方が便利だということは、もうお分かりかと思います。山の頂上で日の出を撮影したり、森の中でしゃがんでキノコを撮影したりする場合、実際の撮影の直後にカメラのセッティングを変えることなく、そのフィルターを使って必要なフラットフィールドを撮影すればいいのです。

　特定の撮影、例えばマクロレンズで撮影をする場合、本文筆者である私は、f/11で撮る傾向があります。これは自分のレンズ場合、相反関係にある被写界深度と解像度の最大公約点がf/11であると感じるからです。これ以上f値を大きくすると、回折現象が解像度に与えるネガティブな影響（\[<https://ja.wikipedia.org/wiki/%E5%B0%8F%E7%B5%9E%E3%82%8A%E3%83%9C%E3%82%B1>　小絞りボケ\]）が出てきます。また、私が一つの絞り値に拘るのは、フラットフィールドの撮影が一種類で済むからです。一つの絞り値で3つのフラットフィールド、最短焦点距離、中間焦点距離、無限大で撮影したものを用意するだけです。小さいフラットフィールドフィルターを持っていれば、これらを簡単に済ませられます。

## 何時フラットフィールドを撮影するか

　以上説明してきたように、貴方の持っている全てのレンズに対し、必要となるフラットフィールドのライブラリーを作りましょう。そして、新しいレンズを購入した、或いは新しいカメラを購入した際には、このライブラリーを更新します。

　また、フラットフィールドをゴミ跡除去に使うのであれば、カメラの撮像センサーをクリーニングした後や、ゴミ跡の位置が変化した時（例　新しゴミ跡ができた、或いはこれまでのゴミ跡が消えた）にもライブラリーを更新します。

## アルゴリズムの特性と概略

　[thumb](image:Rt_ff_dust1.jpg.md)貴方が選択したrawフラットフィールド画像でも、RawTherapeeが自動的に選択した画像でも、補正を加える画像とのホワイトバランスが同じでなくとも構いません。フラットフィールドは、貴方の設定したぼかしの種類や半径の選択に従って、ぼかされます。元々ぼかされた画像であるフラットフィールドは、周辺光量やレンズ焦点距離などを記すテンプレートのようなものであり、編集画像の非均一的な歪みの修正に使われます。面ぼかしはフラットフィールドファイルの箱型ぼかしを使う方法で、これが補正の普通の使い方です。大きなぼかし半径はフラットフィールド自体のノイズやゴミ跡などをぼかしてフラットフィールド画像を滑らかにします。小さいぼかし半径は、フラットフィールド上のこれらの影響をそのまま残すので、補正画像にもその痕跡が残ります。しかし、これを逆手に取ることも出来ます。
例えば、フラットフレームに元画像ファイルと同じゴミ跡があれば、ぼかし半径を0～1ピクセルに設定することで、ゴミによって暗くなった部分を消し去ることが出来るわけです。もし、カメラが常にラインノイズを発生させるのであ
れば、垂直、水平、或いは垂直＋水平のオプションを使って修正します。例えば、常に画像に垂直ラインのノイズが現れる場合は、フラットフィードファイルに垂直なぼかしを施して、そのノイズを帳消しにします。

## フラットフレームの用意

[thumbに](image:Flatfield_flatfields.jpg.md)表示されたフラットフィールドのサムネイル画像\]\]
　撮影画像に現れる非均一性は、以下の様なパラメータで引き起こされます：

- カメラ（\[<https://ja.wikipedia.org/wiki/%E3%83%87%E3%82%B8%E3%82%BF%E3%83%AB%E3%83%90%E3%83%83%E3%82%AF>　デジタルバック\]の場合は、カメラとセンサーのコンビネーション）
- レンズ
- 焦点距離
- 絞り
- ティルトシフトレンズ

　レンズを組み合わせたカメラを、異なった絞り（色々な絞りで撮影することを想定し）で撮影
したフラットフレームのライブラリーを用意することをお奨めします。また、後で使い易いように、状況に応じた名前を（上記のパラメータ全てが望ましい）フラットフィールドに付けておいた方がいいでしょう。フラットフィールド補正の処理が行われる際には、これらのデータがExifファイルから読み込まれます。フラットフレームは特定のディレクトリーに保存される必要があります。RawTherapeeでは、“環境設定→画像処理タブ→フラットフィールド→フラットフレームディレクトリー”で行います。ディレクトリーの設定は、内容の分析から始めます。適用できる
ファイルの数やテンプレートがユーザーインターフェイスに表示されます（保存されているフラットフィールド画像の枚数によっては、表示に少し時間がかかるかもしれません）。

## ファイルブラウザで使うメニューオプション

[thumbでの](image:Flatfield_moveto.jpg.md)、フラットフィールド選択操作\]\]
　フラットフィールド画像の適用と管理は、ファイルブラウザタブでも可能です、サムネイル画像
を右　クリックし、“フラットフィールド”オプションを使います。オプションで、3つのサブオプションが表示されます：

- “フラットフィールド選択”を選ぶと、ファイル選択ダイアログが表示されるので、その中から編集画像に適用するフラットフィールドを選びます。
- “自動選択”を選ぶと、自動選択オプションが働き、編集画像に適合するフラットフィールドが選ばれます。
- “フラットフィールド・ディレクトリーに移動”を選ぶと、選択された画像が環境設定で特定されているディレクトリーに移動します。

  

## 自動選択

[thumb](image:Flatfield_autoselection.jpg.md)
　フラットフィールドの自動選択にチェックを入れると、RawTherapeeが自動的に環境設定で特定しているディレクトリーから、カメラのメーカー、機種、レンズ、焦点距離、絞り、フラットフィールドの作成日で、符合するファイルを探します、正確にマッチングするファイルが無ければ、修正に適した最も近いファイルを選びます。ファイルが見つかると、そのフラットフィールド画像のファイル名が、絞り値と共に表示されます。適合するファイルがない場合は、フラット補正は適用されずその旨がメッセージとして表示されます。もし、正確にマッチするファイルが複数存在する場合は、それらのデータの平均が補正に適用されます。

　自動選択のプログラムはティルトシフトレンズの使用を想定しておりませんので、このレンズを使って撮ったフラットフィールドは、メインのディレクトリーに保存するべきではありま
せん。寧ろ、それが判別できるような名前を付けたサブディレクトリーを作って保存しておく方
がいいでしょう。この様な特別のフラットフィールドファイルの適用は手動で行うようにします。  

## 自動マッチングの論理

　フラットフィールド検索の鍵（ffInfo::key）は：

- カメラメーカー
- 機種名
- レンズ
- 焦点距離
- 絞り

　2要素で最適なフラットフィールド選択を行います：

- 上記の鍵が完全に一致する画像が複数見つかれば、焦点距離の短いものを選択
- 一致する画像が無ければ、全ての画像からレンズとシャッター速度が同じで、焦点距離
  の短い画像を選択

## ぼかしの種類

面  
デフォルトに使われているぼかしの種類で、画像の全ての方向にぼかし操作を行うので、一般的に最も便利な種類です。周辺光量不足や色被りを補正するのに有効です。

垂直方向  
フラットフィールドを垂直方向でぼかし、垂直方向の非均一性を補正します。縦方向センサーの読み出しで、列の間に異体がある場合に便利です。

水平方向  
フラットフィールドを水平方向でぼかし、水平方向の非均一性を補正します。横方向センサーの読み出しで、行間に異体がある場合に便利です。

垂直方向+水平方向  
フラットフィールドを水平方向にぼかした後、垂直方向にぼかし、垂直方向と水平方向の非均一性を補正します。

　注意：垂直方向と水平方向の概念は、rawファイルの撮影で撮像センサーがどの様に位置しているかに関係しています。Rawファイルの属性は撮影が水平であろうが縦であろうが変わりませんが、データの保存形式が水平か縦かはカメラ機種によって異なります。よって、ぼかしタイプを選ぶ際は、貴方のカメラにとって正しい方向を選んで下さい。

## ぼかしの半径

　フラットフィールドのデータをぼかす度合いをこれで決めます。デフォルト値に設定されているのは　32で、普通はこれでノイズによるrawデータの局地的変質は排除できます。0に設定するとぼかし操作がスキップされ、撮像センサー上のゴミやその他の破片データを修正するのに使えますが（それらの位置が変わっていないことが前提です）、その代わり、フラットフィールドのノイズが編集画像に反映されます。この様な補正を行う場合、出来るだけ低いISO値と適正露出で撮影されたノイズの少ないフラットフレームを用意しておくことが求められます。

## クリップコントロール

　フラットフィールドを適用すると、その補正によって、実際の画像の中の露出オーバーに近い部分が、本当の露出オーバーになってしまうことがあります。クリップコントロールを有効にすると、露出オーバーにならないようフラットフィールド画像を制御してくれますが、この機能を適用する以前に、実際の画像に既に露出オーバーがあると、色被りを起こす可能性があります。従って貴方の画像が既に露出オーバーである場合は、この機能を有効にしない方がいいでしょう。

　このクリップコントロールを正確に理解するには、少し技術的に話をしなければなりません。フラットフィールド機能は、フラットフィールド画像の中心部と他の部分（例　非均一性が認められるような周辺部）で測った露出の違いを使って、元画像の同じ非均一部分を補正しています。フラットフィールド画像の中心部に比べ、他の部分の露出がどれだけ暗いかに応じて、元画像の非均一部分の露出を増やすのです。クリップコントロールが無効、或いは設定値が0の場合は、フラットフィールド補正機能はこの差分だけ元画像の非均一ピクセルの露光量を増やしますが、時としてこれにより一部のピクセルがクリッピングしてしまうことがあります。有効（且つ、0以上の設定値）の場合は、クリップコントロールが元画像のホワイトレベルを考慮して露光量を増やすので、ピクセルがホワイトレベルの値を超えることがないのです。

　例えば、元画像の非均一のピクセルに必要な露光補正量が、rawのホワイトレベル“1”に対し1.25なってしまうような場合は、先程の差分が1/1.25=0.8になり、この数値は、他のピクセル値がホワイトレベルを超えないようにするための計算に使われます。

　スライダーの計算式は、`クリップコントロール　=（1－調整要素）x100`

なので、先の0.8を使うと、スライダー値は20ということになります。
